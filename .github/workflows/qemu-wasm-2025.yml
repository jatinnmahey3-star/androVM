name: Build QEMU WebAssembly (Meson + Emscripten)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3-pip cmake ninja-build
          pip install meson

      - name: Setup Emscripten SDK
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest
          source ./emsdk_env.sh
          emcc -v

      - name: Create Emscripten cross file for Meson
        run: |
          mkdir -p .github/workflows
          cat > .github/workflows/emscripten.cross << 'EOF'
[binaries]
c = '/home/runner/work/androVM/androVM/emsdk/upstream/emscripten/emcc'
cpp = '/home/runner/work/androVM/androVM/emsdk/upstream/emscripten/em++'
ar = '/home/runner/work/androVM/androVM/emsdk/upstream/emscripten/emar'
strip = 'true'
pkgconfig = '/usr/bin/pkg-config'

[host_machine]
system = 'wasm'
cpu_family = 'wasm32'
cpu = 'wasm32'
endian = 'little'

[properties]
needs_exe_wrapper = true
EOF

      - name: Clone QEMU source
        run: git clone --depth=1 https://gitlab.com/qemu-project/qemu.git qemu-src

      - name: Configure QEMU for WebAssembly (Meson)
        run: |
          source ./emsdk/emsdk_env.sh
          mkdir -p build-wasm
          cd build-wasm
          meson setup . ../qemu-src \
            --cross-file ../.github/workflows/emscripten.cross \
            -Dtargets=x86_64-softmmu \
            -Dtcg-interpreter=true \
            -Dglib=disabled \
            -Dgtk=disabled \
            -Dsdl=disabled \
            -Dxen=disabled \
            -Dkvm=disabled \
            -Dvnc=disabled \
            -Dopengl=disabled \
            -Ddocs=false \
            -Dtools=false \
            -Duser=false

      - name: Build QEMU (WebAssembly)
        run: |
          source ./emsdk/emsdk_env.sh
          cd build-wasm
          ninja -j$(nproc)

      - name: Collect WASM + JS
        run: |
          mkdir -p dist
          cp build-wasm/qemu-system-x86_64.js dist/ 2>/dev/null || true
          cp build-wasm/qemu-system-x86_64.wasm dist/ 2>/dev/null || true
          echo "âœ… Build complete. Files in dist/:"
          ls -lh dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qemu-wasm-browser
          path: dist/
